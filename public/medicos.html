<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Médicos Cadastrados</title>
  <style>
    /* Estilos mantidos iguais */
    .error-container {
      text-align: center;
      padding: 20px;
      background-color: #f8d7da;
      border-radius: 5px;
      margin: 20px auto;
      max-width: 600px;
    }
    .retry-btn {
      background-color: #0055a5;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 15px;
    }
  </style>
</head>
<body>

  <!-- Cabeçalho mantido igual -->

  <div id="loadingIndicator" style="display: none;">
    <span class="loading"></span> Carregando médicos...
  </div>

  <div id="errorContainer" class="error-container" style="display: none;"></div>
  
  <table>
    <thead>
      <tr>
        <th>Nome</th>
        <th>Sexo</th>
        <th>Telefone</th>
        <th>CRM</th>
        <th>Especialidade</th>
        <th>Ações</th>
      </tr>
    </thead>
    <tbody id="medicosList">
      <!-- Médicos serão carregados aqui -->
    </tbody>
  </table>

  <script>
    // Função para carregar os médicos - ATUALIZADA
    async function carregarMedicos() {
      const loadingIndicator = document.getElementById('loadingIndicator');
      const tableBody = document.getElementById('medicosList');
      const errorContainer = document.getElementById('errorContainer');
      
      // Resetar displays
      loadingIndicator.style.display = 'block';
      tableBody.innerHTML = '';
      errorContainer.style.display = 'none';
      errorContainer.innerHTML = '';

      try {
        const response = await fetch('http://localhost:3000/medicos', {
          credentials: 'include',
          headers: {
            'Accept': 'application/json'
          }
        });
        
        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.mensagem || `Erro no servidor (${response.status})`);
        }

        const medicos = await response.json();

        if (medicos.length === 0) {
          tableBody.innerHTML = `
            <tr>
              <td colspan="6" style="text-align: center;">
                Nenhum médico cadastrado
              </td>
            </tr>`;
          return;
        }

        // Renderiza a lista de médicos
        medicos.forEach(medico => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${medico.nome || 'Não informado'}</td>
            <td>${formatarSexo(medico.sexo)}</td>
            <td>${formatarTelefone(medico.telefone)}</td>
            <td>${medico.crm || 'Não informado'}</td>
            <td>${medico.especialidade || 'Não informado'}</td>
            <td>
              <button class="btn-success" onclick="verAgenda(${medico.id}, '${medico.nome}')">
                Agenda
              </button>
              <button class="btn-primary" onclick="editarMedico(${medico.id})">
                Editar
              </button>
              <button class="btn-danger" onclick="confirmarExclusao(${medico.id}, ${medico.consultas_agendadas || 0})">
                Excluir
              </button>
            </td>
          `;
          tableBody.appendChild(row);
        });

      } catch (error) {
        console.error('Erro ao carregar médicos:', error);
        
        // Mostra mensagem de erro detalhada
        errorContainer.innerHTML = `
          <h3>Erro ao carregar lista de médicos</h3>
          <p>${error.message}</p>
          <button class="retry-btn" onclick="carregarMedicos()">
            Tentar Novamente
          </button>
          ${error.message.includes('banco de dados') ? 
            '<p style="margin-top: 10px;">Verifique se o servidor do banco de dados está rodando</p>' : ''}
        `;
        errorContainer.style.display = 'block';
        
        if (error.message.includes('Não autorizado') || error.message.includes('401')) {
          setTimeout(() => window.location.href = '/login_rh', 2000);
        }
      } finally {
        loadingIndicator.style.display = 'none';
      }
    }

    // Outras funções mantidas iguais...

    // Carrega os médicos quando a página é aberta
    document.addEventListener('DOMContentLoaded', async () => {
      await verificarAutenticacao();
      carregarMedicos();
    });
  </script>
</body>
</html>